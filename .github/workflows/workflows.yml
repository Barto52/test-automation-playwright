name: Playwright Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker Compose
              run: |
                  sudo apt-get update
                  sudo apt-get install -y docker-compose

            - name: Build Docker containers
              run: |
                  docker-compose -f docker-compose.yml up -d --build

            - name: Wait for the app to start
              run: |
                  until curl -s http://localhost:3000; do
                    echo "Waiting for the app to start on localhost:3000..."
                    sleep 5
                  done

            - name: Run Playwright tests
              run: |
                  docker-compose run tests

            - name: Tear down Docker Compose
              if: always()
              run: |
                  docker-compose down

            - name: Upload Playwright test reports
              if: ${{ !cancelled() }}
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
