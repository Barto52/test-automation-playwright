name: Node.js CI with Docker

on:
    push:
        branches: ['master']
    pull_request:
        branches: ['master']

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker
              uses: docker/setup-buildx-action@v2

            - name: Install Docker Compose
              run: |
                  sudo apt-get update
                  sudo apt-get install -y docker-compose

            - name: Build and start Docker containers
              run: |
                  docker-compose up -d --build

            - name: Wait for app to start
              run: |
                  until curl -s http://localhost:3000; do
                    echo "Waiting for the app to start on localhost:3000..."
                    sleep 5
                  done

            - name: Run Playwright tests
              run: docker-compose run tests

            - name: Tear down Docker Compose
              if: always()
              run: docker-compose down
