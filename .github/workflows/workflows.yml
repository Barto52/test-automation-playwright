name: Playwright Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        runs-on: ubuntu-latest
        container:
            image: docker:latest

        steps:
            - uses: actions/checkout@v4

            - name: Run Docker container
              run: |
                  docker run -p 3000:3000 -d jaktestowac/gad:2.7.9

            - name: Wait for the app to start
              run: |
                  docker exec -d bd67951758d9cf425166d41f2a47f56ee81fc24aa21397816cf8cd042d66e878 sh -c "apt-get update && apt-get install -y curl"
                  until curl -s http://localhost:3000; do
                    echo "Waiting for the app to start on localhost:3000..."
                    sleep 5
                  done

            - name: Run Playwright tests
              run: |
                  npx playwright test

            - name: Tear down Docker container
              if: always()
              run: |
                  docker ps -q | xargs docker stop 
                  docker ps -q | xargs docker rm

            - name: Upload Playwright test reports
              if: ${{ !cancelled() }}
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
