name: Playwright Tests

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Docker
              run: |
                  sudo apt-get update
                  sudo apt-get install -y docker.io

            - name: Pull Docker image and start container
              run: |
                  docker run -d -p 3000:3000 jaktestowac/gad:latest

            - name: Wait for the app to start
              run: |
                  until curl -s http://localhost:3000; do
                    echo "Waiting for the app to start on localhost:3000..."
                    sleep 5
                  done

            - name: Run Playwright tests
              run: |
                  npx playwright test

            - name: Tear down Docker container
              if: always()
              run: |
                  docker ps -q --filter "ancestor=jaktestowac/gad:latest" | xargs docker stop
                  docker ps -q --filter "ancestor=jaktestowac/gad:latest" | xargs docker rm

            - name: Upload Playwright test reports
              if: ${{ !cancelled() }}
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30
